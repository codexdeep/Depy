<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Depy Music</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    color-scheme: light dark;
    --bg:#0b0d12; --panel:#121521; --panel-2:#161a27;
    --text:#eaf0ff; --muted:#9aa3ad; --border:#1d2130;
    --accent:#5b86ff; --accent-2:#8aa1ff; --danger:#ff5d6b; --ok:#4cd964;
    --rail:#232838; --thumb:#c9d4ff; --shadow:0 12px 32px rgba(0,0,0,.35);
  }
  * { box-sizing:border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
  header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; position:sticky; top:0; z-index:10; backdrop-filter:saturate(120%) blur(6px); background:linear-gradient(180deg, rgba(18,21,33,.8), rgba(18,21,33,.4)); border-bottom:1px solid var(--border); }
  .brand { font-weight:700; letter-spacing:.2px; }
  .brand span { color:var(--accent); }
  .wrap { padding:16px; display:grid; grid-template-columns: 1.4fr 1fr; gap:16px; }
  .card { background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:12px; }
  .row { display:flex; gap:8px; align-items:center; }
  .row + .row { margin-top:8px; }
  input[type=text], select {
    flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
    background:#0e111a; color:var(--text);
  }
  button { padding:9px 12px; border-radius:12px; border:1px solid var(--border); background:var(--panel-2); color:var(--text); cursor:pointer; }
  button:hover { background:#1a1f2f; }
  .pill { border-radius:999px; }
  .primary { border-color:var(--accent); }
  .danger { border-color:var(--danger); }
  .ok { border-color:var(--ok); }

  /* Player box */
  .playerBox { border-radius:16px; overflow:hidden; border:1px solid var(--border); background:#0a0d14; }
  #player { width:100%; aspect-ratio:16/9; display:block; }
  .transport { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
  .stack { display:grid; gap:6px; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .label { font-size:12px; color:var(--muted); }
  .time { display:flex; justify-content:space-between; font-variant-numeric:tabular-nums; color:var(--muted); font-size:12px; }
  input[type=range]{
    -webkit-appearance:none; appearance:none; width:100%; height:10px; border-radius:999px;
    background:linear-gradient(90deg, var(--accent) var(--fill,0%), var(--rail) var(--fill,0%));
    border:1px solid var(--border);
  }
  input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:var(--thumb); border:1px solid #3b3f49; }

  /* Library */
  .tools { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .list { display:grid; gap:10px; margin-top:10px; }
  .libItem, .plItem {
    display:grid; grid-template-columns: 80px 1fr auto; gap:10px; align-items:center;
    background:var(--panel-2); border:1px solid var(--border); border-radius:12px; padding:8px;
  }
  .thumb { width:100%; aspect-ratio:16/9; border-radius:8px; overflow:hidden; background:#0b0f18; display:grid; place-items:center; color:var(--muted); font-size:11px; }
  .meta { display:grid; gap:2px; }
  .title { font-size:14px; }
  .sub { font-size:12px; color:var(--muted); }
  .btns { display:flex; gap:6px; }
  .empty { color:var(--muted); font-size:13px; padding:10px; text-align:center; border:1px dashed var(--border); border-radius:12px; }

  /* Playlist showcase */
  .showcase { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap:10px; margin-top:10px; }
  .pcard { background:var(--panel-2); border:1px solid var(--border); border-radius:12px; padding:8px; display:grid; gap:8px; }
  .pcard h4 { margin:0; font-size:14px; }
  .pcard .count { font-size:12px; color:var(--muted); }

  @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; } }
</style>
</head>
<body>
  <header>
    <div class="brand">Depy <span>Music</span></div>
    <div style="font-size:12px; color:var(--muted)">Paste link → Add → Play</div>
  </header>

  <div class="wrap">
    <!-- Left: Player -->
    <div class="card">
      <div class="row">
        <input id="ytUrl" type="text" placeholder="Paste YouTube link or ID" />
        <button id="addBtn" class="pill primary">Add</button>
        <button id="playLast" class="pill">Last</button>
      </div>

      <div class="playerBox">
        <div id="player" aria-label="YouTube player"></div>
      </div>

      <div class="transport">
        <button id="back30" class="pill">« 30s</button>
        <button id="back10" class="pill">« 10s</button>
        <button id="playPause" class="pill primary">Play</button>
        <button id="fwd10" class="pill">10s »</button>
        <button id="fwd30" class="pill">30s »</button>
        <button id="mute" class="pill danger">Unmute</button>
      </div>

      <div class="grid-2" style="margin-top:8px">
        <div class="stack">
          <div class="label">Seek</div>
          <input id="seek" type="range" min="0" max="1000" value="0" step="1" />
          <div class="time"><span id="curT">00:00</span><span id="durT">00:00</span></div>
        </div>
        <div class="stack">
          <div class="label">Volume</div>
          <input id="volume" type="range" min="0" max="100" value="60" step="1" />
          <div class="label" id="status">Idle</div>
        </div>
      </div>

      <div class="label" style="margin-top:6px">Tip: Space/K play-pause, J/L or ←/→ seek, Shift+←/→ ±30s, ↑/↓ volume. Autoplay with sound needs a click to comply with browser policy.</div>
    </div>

    <!-- Right: Library and Playlists -->
    <div class="card">
      <div class="tools">
        <input id="search" type="text" placeholder="Search library" />
        <select id="sortBy">
          <option value="added_desc">Newest first</option>
          <option value="added_asc">Oldest first</option>
          <option value="title_asc">Title A–Z</option>
          <option value="title_desc">Title Z–A</option>
        </select>
        <button id="clearLib" class="pill danger">Clear</button>
      </div>

      <div class="list" id="library"></div>

      <div class="row" style="margin-top:10px">
        <input id="plName" type="text" placeholder="New playlist name" />
        <button id="createPl" class="pill ok">Create</button>
      </div>
      <div class="row">
        <select id="plSelect"></select>
        <button id="deletePl" class="pill danger">Delete</button>
      </div>

      <div class="list" id="plItems"></div>

      <h3 style="margin:10px 0 6px 0; font-size:14px">Playlists</h3>
      <div class="showcase" id="plShow"></div>
    </div>
  </div>

<script>
  // Parameters to minimize YouTube UI within policy [web:2][web:41]
  const playerVars = {
    controls: 0,           // hide native controls; custom UI used
    rel: 0,                // related only from same channel at end
    modestbranding: 1,     // reduce logo presence where allowed
    playsinline: 1,
    iv_load_policy: 3      // hide annotations
  };

  // Load IFrame API [web:1]
  (function(){const s=document.createElement('script');s.src='https://www.youtube.com/iframe_api';document.head.appendChild(s);})();

  // State and storage [web:25][web:45]
  const KS = { lib:'depy_lib_v1', pl:'depy_pl_v1', last:'depy_last_v1' };
  let player=null, duration=0, seekTimer=null, userSeeking=false;
  let library = loadJSON(KS.lib, []);      // [{id, title, channel, added}]
  let playlists = loadJSON(KS.pl, {});     // {name: [videoId,...]}
  let activePl = Object.keys(playlists)[0] || null;

  function loadJSON(k, def){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch{ return def; } }
  function saveJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

  // YouTube bootstrap [web:1]
  window.onYouTubeIframeAPIReady = function(){
    player = new YT.Player('player', {
      width:'1280', height:'720', playerVars,
      events:{ onReady, onStateChange, onError }
    });
  };

  function onReady(){
    setStatus('Ready'); player.mute(); document.getElementById('mute').textContent='Unmute';
    bindControls(); renderAll(); startSeekTimer();
    const last = loadJSON(KS.last, null);
    if(last?.id){ player.cueVideoById(last.id); setStatus('Cued: '+(last.title||last.id)); }
  }

  function onStateChange(e){
    if(e.data===YT.PlayerState.PLAYING){
      duration=Math.max(1, Math.floor(player.getDuration()||0));
      q('#durT').textContent = fmt(duration);
      q('#playPause').textContent='Pause';
      setStatus('Playing');
    } else if(e.data===YT.PlayerState.PAUSED){
      q('#playPause').textContent='Play'; setStatus('Paused');
    } else if(e.data===YT.PlayerState.ENDED){
      q('#playPause').textContent='Play'; setStatus('Ended'); nextInPlaylist();
    } else if(e.data===YT.PlayerState.BUFFERING){
      setStatus('Buffering…');
    }
  }

  function onError(e){ setStatus('Error: '+e.data); alert('Failed to load video.'); }

  // Helpers
  const q = s=>document.querySelector(s);
  const pad = n=>String(Math.floor(n)).padStart(2,'0');
  function fmt(sec){ sec=Math.max(0, sec|0); const h=(sec/3600)|0, m=((sec%3600)/60)|0, s=sec%60|0; return h?`${h}:${pad(m)}:${pad(s)}`:`${pad(m)}:${pad(s)}`; }
  function setStatus(t){ q('#status').textContent=t; }
  function setRangeFill(el, p){ el.style.setProperty('--fill', `${Math.min(100, Math.max(0, p))}%`); }

  function extractVideoId(input){
    if(!input) return '';
    input=input.trim();
    if(/^[\w-]{11}$/.test(input)) return input;
    try {
      const u=new URL(input);
      if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
      if(u.hostname.includes('youtube.com')){
        if(u.pathname.startsWith('/watch')) return u.searchParams.get('v')||'';
        if(u.pathname.startsWith('/shorts/')) return u.pathname.split('/')[2]||'';
        if(u.pathname.startsWith('/embed/')) return u.pathname.split('/')[2]||'';
      }
    } catch {}
    return '';
  }

  // Title/channel via player data after cue [web:1]
  function enrichMeta(id){
    return new Promise(resolve=>{
      try{
        player.cueVideoById(id);
        let tries=0;
        const t=setInterval(()=>{
          tries++;
          const d=player.getVideoData?.();
          if(d && d.title){
            clearInterval(t);
            resolve({title:d.title, channel:d.author});
          } else if(tries>20){ clearInterval(t); resolve({title:id, channel:''}); }
        }, 150);
      }catch{ resolve({title:id, channel:''}); }
    });
  }

  // Library actions
  async function addToLibrary(raw){
    const id = extractVideoId(raw);
    if(!id){ alert('Invalid YouTube link/ID'); return; }
    let item = library.find(x=>x.id===id);
    if(!item){
      const meta = await enrichMeta(id);
      item = { id, title: meta.title || id, channel: meta.channel || '', added: Date.now() };
      library.unshift(item);
      saveJSON(KS.lib, library);
    }
    // cue selected
    player.cueVideoById(id);
    setStatus('Cued: '+(item.title||id));
    saveJSON(KS.last, {id, title:item.title});
    renderLibrary();
  }

  function removeFromLibrary(id){
    library = library.filter(x=>x.id!==id);
    Object.keys(playlists).forEach(n=>{ playlists[n]=playlists[n].filter(v=>v!==id); });
    saveJSON(KS.lib, library); saveJSON(KS.pl, playlists);
    renderAll();
  }

  function renderLibrary(){
    const node = q('#library'); node.innerHTML='';
    const term = q('#search').value.trim().toLowerCase();
    const sort = q('#sortBy').value;
    let list = library.slice();

    if(term){
      list = list.filter(x=> (x.title||'').toLowerCase().includes(term) || (x.channel||'').toLowerCase().includes(term) || x.id.includes(term));
    }
    if(sort==='added_desc') list.sort((a,b)=>b.added-a.added);
    if(sort==='added_asc') list.sort((a,b)=>a.added-b.added);
    if(sort==='title_asc') list.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
    if(sort==='title_desc') list.sort((a,b)=> (b.title||'').localeCompare(a.title||''));

    if(list.length===0){
      node.innerHTML = '<div class="empty">No items. Add a link to start.</div>';
      return;
    }

    list.forEach(item=>{
      const el = document.createElement('div'); el.className='libItem';
      el.innerHTML = `
        <div class="thumb"><img loading="lazy" alt="" src="https://i.ytimg.com/vi/${item.id}/hqdefault.jpg" style="width:100%;height:100%;object-fit:cover"/></div>
        <div class="meta">
          <div class="title">${escapeHtml(item.title||item.id)}</div>
          <div class="sub">${escapeHtml(item.channel||'')}</div>
        </div>
        <div class="btns">
          <button class="pill ok" data-act="play">Play</button>
          <button class="pill" data-act="addpl">Add</button>
          <button class="pill danger" data-act="remove">Remove</button>
        </div>`;
      el.querySelector('[data-act=play]').onclick=()=>{
        player.loadVideoById(item.id);
        setStatus('Playing: '+(item.title||item.id));
        saveJSON(KS.last, {id:item.id, title:item.title||item.id});
      };
      el.querySelector('[data-act=addpl]').onclick=()=>{
        if(!activePl){ alert('Create/select a playlist first'); return; }
        addToPlaylist(activePl, item.id);
      };
      el.querySelector('[data-act=remove]').onclick=()=>removeFromLibrary(item.id);
      node.appendChild(el);
    });
  }

  // Playlists
  function createPlaylist(name){
    name=(name||'').trim();
    if(!name){ alert('Enter a name'); return; }
    if(playlists[name]){ alert('Playlist exists'); return; }
    playlists[name]=[]; activePl=name; saveJSON(KS.pl, playlists); renderPlaylists(); renderShowcase();
  }
  function deletePlaylist(name){
    if(!name||!playlists[name]) return;
    delete playlists[name];
    activePl = Object.keys(playlists)[0] || null;
    saveJSON(KS.pl, playlists); renderPlaylists(); renderShowcase(); renderPlItems();
  }
  function addToPlaylist(name, id){
    if(!name||!playlists[name]) return;
    if(!playlists[name].includes(id)){ playlists[name].push(id); saveJSON(KS.pl, playlists); renderPlItems(); renderShowcase(); }
  }
  function moveInPlaylist(name, idx, dir){
    const arr=playlists[name]; if(!arr) return;
    const j=idx+dir; if(j<0||j>=arr.length) return;
    [arr[idx], arr[j]]=[arr[j], arr[idx]];
    saveJSON(KS.pl, playlists); renderPlItems();
  }
  function removeFromPlaylist(name, idx){
    const arr=playlists[name]; if(!arr) return;
    arr.splice(idx,1); saveJSON(KS.pl, playlists); renderPlItems(); renderShowcase();
  }
  function renderPlaylists(){
    const sel=q('#plSelect'); sel.innerHTML='';
    const names=Object.keys(playlists);
    if(names.length===0){ sel.innerHTML='<option value="">(No playlists)</option>'; activePl=null; }
    else {
      names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
      if(!activePl || !playlists[activePl]) activePl=names[0];
      sel.value=activePl;
    }
    renderPlItems();
  }
  function renderPlItems(){
    const node=q('#plItems'); node.innerHTML='';
    if(!activePl){ node.innerHTML='<div class="empty">No playlist selected.</div>'; return; }
    const arr=playlists[activePl]||[];
    if(arr.length===0){ node.innerHTML='<div class="empty">Empty playlist. Add items from Library.</div>'; return; }
    arr.forEach((id, idx)=>{
      const meta=library.find(x=>x.id===id);
      const el=document.createElement('div'); el.className='plItem';
      el.innerHTML=`
        <div class="thumb"><img loading="lazy" alt="" src="https://i.ytimg.com/vi/${id}/mqdefault.jpg" style="width:100%;height:100%;object-fit:cover"/></div>
        <div class="meta">
          <div class="title">${escapeHtml(meta?.title||id)}</div>
          <div class="sub">${escapeHtml(meta?.channel||'')}</div>
        </div>
        <div class="btns">
          <button class="pill ok" data-act="play">Play</button>
          <button class="pill" data-act="up">↑</button>
          <button class="pill" data-act="down">↓</button>
          <button class="pill danger" data-act="remove">Remove</button>
        </div>`;
      el.querySelector('[data-act=play]').onclick=()=>{ player.loadVideoById(id); setStatus('Playing: '+(meta?.title||id)); saveJSON(KS.last,{id, title:meta?.title||id}); };
      el.querySelector('[data-act=up]').onclick=()=>moveInPlaylist(activePl, idx, -1);
      el.querySelector('[data-act=down]').onclick=()=>moveInPlaylist(activePl, idx, +1);
      el.querySelector('[data-act=remove]').onclick=()=>removeFromPlaylist(activePl, idx);
      node.appendChild(el);
    });
  }

  function renderShowcase(){
    const node=q('#plShow'); node.innerHTML='';
    const names=Object.keys(playlists);
    if(names.length===0){ node.innerHTML='<div class="empty">No playlists yet.</div>'; return; }
    names.forEach(n=>{
      const ids=playlists[n]; const first=ids[0];
      const el=document.createElement('div'); el.className='pcard';
      el.innerHTML=`
        <div class="thumb"><img loading="lazy" alt="" src="${first?`https://i.ytimg.com/vi/${first}/hqdefault.jpg`:'https://i.ytimg.com/img/no_thumbnail.jpg'}" style="width:100%;height:100%;object-fit:cover;border-radius:8px"/></div>
        <h4>${escapeHtml(n)}</h4>
        <div class="count">${ids.length} items</div>
        <div class="btns">
          <button class="pill" data-act="select">Open</button>
          <button class="pill ok" data-act="play">Play first</button>
        </div>`;
      el.querySelector('[data-act=select]').onclick=()=>{ activePl=n; renderPlaylists(); };
      el.querySelector('[data-act=play]').onclick=()=>{ if(first){ player.loadVideoById(first); setStatus('Playing: '+(library.find(x=>x.id===first)?.title||first)); } };
      node.appendChild(el);
    });
  }

  function nextInPlaylist(){
    if(!activePl) return;
    const arr=playlists[activePl]||[];
    const cur = player.getVideoData?.().video_id;
    const i = arr.indexOf(cur);
    if(i>=0 && i+1<arr.length){ const next=arr[i+1]; player.loadVideoById(next); setStatus('Playing: '+(library.find(x=>x.id===next)?.title||next)); saveJSON(KS.last,{id:next, title:library.find(x=>x.id===next)?.title||next}); }
  }

  // Controls
  function bindControls(){
    q('#addBtn').onclick=()=>{ const v=q('#ytUrl').value; addToLibrary(v); q('#ytUrl').value=''; };
    q('#playLast').onclick=()=>{ const last=loadJSON(KS.last,null); if(last?.id){ player.loadVideoById(last.id); setStatus('Playing: '+(last.title||last.id)); } };
    q('#clearLib').onclick=()=>{ if(confirm('Clear library and remove from playlists?')){ library=[]; Object.keys(playlists).forEach(n=>playlists[n]=[]); saveJSON(KS.lib,library); saveJSON(KS.pl,playlists); renderAll(); } };
    q('#createPl').onclick=()=>createPlaylist(q('#plName').value);
    q('#deletePl').onclick=()=>{ const n=q('#plSelect').value; if(n && confirm('Delete "'+n+'"?')) deletePlaylist(n); };
    q('#plSelect').onchange=()=>{ activePl=q('#plSelect').value||null; renderPlItems(); };

    q('#search').oninput=renderLibrary;
    q('#sortBy').onchange=renderLibrary;

    const seek=q('#seek'), vol=q('#volume'), muteBtn=q('#mute');

    q('#playPause').onclick=()=>{ const s=player.getPlayerState(); if(s===YT.PlayerState.PLAYING) player.pauseVideo(); else player.playVideo(); };
    q('#back10').onclick=()=>skipBy(-10);
    q('#fwd10').onclick=()=>skipBy(10);
    q('#back30').onclick=()=>skipBy(-30);
    q('#fwd30').onclick=()=>skipBy(30);

    muteBtn.onclick=()=>{ if(player.isMuted()){ player.unMute(); muteBtn.textContent='Mute'; } else { player.mute(); muteBtn.textContent='Unmute'; } };
    vol.addEventListener('input', e=>{ const v=Number(e.target.value); setRangeFill(vol, v); if(v<=0){ player.mute(); muteBtn.textContent='Unmute'; } else { player.unMute(); muteBtn.textContent='Mute'; player.setVolume(v); } });

    seek.addEventListener('mousedown', ()=>userSeeking=true);
    seek.addEventListener('touchstart', ()=>userSeeking=true, {passive:true});
    seek.addEventListener('input', ()=>{ const p=Number(seek.value)/10; setRangeFill(seek, p); });
    ['mouseup','touchend','change'].forEach(evt=>{
      seek.addEventListener(evt, ()=>{ const p=Number(seek.value)/1000; if(duration>0){ const t=Math.max(0, Math.min(duration-0.5, p*duration)); player.seekTo(t, true); } userSeeking=false; }, {passive:true});
    });

    window.addEventListener('keydown', e=>{
      if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if(e.key===' '||e.key.toLowerCase()==='k'){ e.preventDefault(); q('#playPause').click(); }
      else if(e.key.toLowerCase()==='j'||e.key==='ArrowLeft'){ e.preventDefault(); skipBy(e.shiftKey?-30:-10); }
      else if(e.key.toLowerCase()==='l'||e.key==='ArrowRight'){ e.preventDefault(); skipBy(e.shiftKey?30:10); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); const v=Math.min(100, Number(vol.value)+5); vol.value=v; setRangeFill(vol,v); if(v===0){ player.mute(); muteBtn.textContent='Unmute'; } else { player.unMute(); muteBtn.textContent='Mute'; player.setVolume(v); } }
      else if(e.key==='ArrowDown'){ e.preventDefault(); const v=Math.max(0, Number(vol.value)-5); vol.value=v; setRangeFill(vol,v); if(v===0){ player.mute(); muteBtn.textContent='Unmute'; } else { player.unMute(); muteBtn.textContent='Mute'; player.setVolume(v); } }
    });
  }

  function skipBy(delta){
    const now=player.getCurrentTime()||0, end=player.getDuration()||0;
    const t=Math.max(0, Math.min(end-0.25, now+delta)); player.seekTo(t, true);
  }
  function startSeekTimer(){
    if(seekTimer) clearInterval(seekTimer);
    const seek=q('#seek'), cur=q('#curT'), dur=q('#durT'), vol=q('#volume');
    seekTimer=setInterval(()=>{
      if(!player || userSeeking) return;
      const d=player.getDuration()||0; if(d>0) duration=Math.floor(d);
      const t=player.getCurrentTime()||0;
      cur.textContent=fmt(t); if(duration>0) dur.textContent=fmt(duration);
      const p=duration>0 ? Math.max(0, Math.min(1, t/duration)) : 0;
      const sliderVal=Math.round(p*1000);
      if(Number(seek.value)!==sliderVal){ seek.value=String(sliderVal); setRangeFill(seek, p*100); }
      const pv=player.getVolume?.() ?? 60;
      if(!player.isMuted() && Number(vol.value)!==pv){ vol.value=pv; setRangeFill(vol, pv); }
    }, 200);
  }

  function renderAll(){ renderLibrary(); renderPlaylists(); renderShowcase(); }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
</script>
</body>
</html>
